<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻将记分器</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 设置 Inter 字体 -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* 浅灰色背景 */
            min-height: 100vh; /* 确保body至少占满视口高度 */
            display: flex;
            flex-direction: column; /* 允许内容垂直堆叠 */
            align-items: center; /* 水平居中内容 */
            padding: 1rem; /* 页面内边距 */
            box-sizing: border-box; /* 边框盒模型 */
        }
        .main-content-wrapper {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            flex-shrink: 0; /* 防止内容收缩 */
            overflow-y: auto; /* 允许内容垂直滚动 */
            max-height: calc(100vh - 2rem); /* 最大高度以适应屏幕，留出边距 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }
        /* Player name input specific styles for dynamic font size */
        .player-name-input {
            text-align: center;
            font-size: 1rem; /* Default font size */
            min-width: 0; /* Allow shrinking */
            flex-grow: 1; /* Allow growing */
        }
        /* Adjust font size for more players */
        .player-name-input-small {
            font-size: 0.8rem; /* Smaller font for more players */
        }
        /* Player label (东, 南, 西, 北) specific styles */
        .player-label {
            text-align: center;
            font-weight: bold;
            color: #4a5568; /* Tailwind gray-700 */
            flex-grow: 1; /* Allow growing */
            min-width: 0; /* Allow shrinking */
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis */
            font-size: 0.9rem; /* Slightly smaller than default for labels */
        }
    </style>
    <!-- PWA Manifest 文件 -->
    <link rel="manifest" href="/manifest.json">
</head>
<body class="min-h-screen flex flex-col items-center p-4">
    <div class="main-content-wrapper">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">麻将记分器</h1>

        <!-- 分值设置区域 -->
        <div class="mb-6 bg-blue-50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold mb-4 text-blue-800">分值设置</h2>
            <div class="flex flex-wrap justify-around gap-4">
                <div class="flex-1 min-w-[calc(33%-1rem)]">
                    <label for="baseScore" class="block text-gray-700 text-sm font-bold mb-2">底分:</label>
                    <input type="number" id="baseScore" value="5" min="0" 
                           class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200"
                           inputmode="numeric" pattern="[0-9]*" onfocus="this.value = '';">
                </div>
                <div class="flex-1 min-w-[calc(33%-1rem)]">
                    <label for="flowerScore" class="block text-gray-700 text-sm font-bold mb-2">花分:</label>
                    <input type="number" id="flowerScore" value="5" min="0" 
                           class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200"
                           inputmode="numeric" pattern="[0-9]*" onfocus="this.value = '';">
                </div>
                <div class="flex-1 min-w-[calc(33%-1rem)]">
                    <label for="laziScore" class="block text-gray-700 text-sm font-bold mb-2">辣子:</label>
                    <input type="number" id="laziScore" value="100" min="0" 
                           class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200"
                           inputmode="numeric" pattern="[0-9]*" onfocus="this.value = '';">
                </div>
            </div>
        </div>

        <!-- 玩家管理区域 -->
        <div class="mb-6 bg-green-50 p-4 rounded-lg">
            <h2 class="text-xl font-semibold mb-4 text-green-800">玩家管理 (名字字数最多2个字)</h2>
            <!-- Removed the instruction text below -->
            <div id="playerListContainer" class="max-h-60 overflow-y-auto border border-gray-200 rounded-lg p-2 bg-white">
                <div id="playerLabels" class="flex justify-around gap-2 mb-2">
                    <!-- 玩家标签 (东, 南, 西, 北...) 将在这里动态添加 -->
                </div>
                <div id="playerInputs" class="flex justify-around gap-2">
                    <!-- 玩家姓名输入框将在这里动态添加 -->
                </div>
            </div>
        </div>

        <!-- 开始记分按钮 -->
        <button id="startGameBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transition duration-200 transform hover:scale-105">
            开始记分
        </button>

        <!-- 消息提示框 -->
        <div id="messageBox" class="hidden mt-4 p-3 rounded-lg text-sm text-center" role="alert"></div>
    </div>

    <script>
        // 全局数据存储
        let settings = {
            baseScore: 5,   // 默认底分
            flowerScore: 5, // 默认花分
            laziScore: 100  // 默认辣子
        };

        // 这些是默认的玩家槽位标签
        const DEFAULT_PLAYER_PLACEHOLDERS = ['东', '南', '西', '北', '中', '发', '白'];

        // 这个数组将管理每个玩家输入槽位的状态
        // 每个元素是 { id: string, defaultLabel: string, name: string }
        // name 存储用户在输入框中填写的实际姓名，如果为空则使用 defaultLabel
        let playerInputSlots = [];

        // 获取 DOM 元素
        const baseScoreInput = document.getElementById('baseScore');
        const flowerScoreInput = document.getElementById('flowerScore');
        const laziScoreInput = document.getElementById('laziScore');
        const playerLabelsContainer = document.getElementById('playerLabels'); // 新增：玩家标签容器
        const playerInputsContainer = document.getElementById('playerInputs'); // 新增：玩家输入框容器
        const startGameBtn = document.getElementById('startGameBtn');
        const messageBox = document.getElementById('messageBox');

        // --- 消息提示函数 ---
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-700');
            }
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // 3秒后隐藏
        }

        // --- 数据加载与保存 (使用 localStorage) ---
        function loadData() {
            const savedSettings = localStorage.getItem('mahjongSettings');
            const savedPlayerInputSlots = localStorage.getItem('mahjongPlayerInputSlots');

            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                baseScoreInput.value = settings.baseScore;
                flowerScoreInput.value = settings.flowerScore;
                laziScoreInput.value = settings.laziScore;
            }

            if (savedPlayerInputSlots) {
                const loadedSlots = JSON.parse(savedPlayerInputSlots);
                // 确保加载的槽位数量与默认数量一致，并填充或截断
                playerInputSlots = DEFAULT_PLAYER_PLACEHOLDERS.map((defaultLabel, index) => {
                    const loadedSlot = loadedSlots.find(s => s.defaultLabel === defaultLabel); // 尝试匹配默认标签
                    if (loadedSlot) {
                        return {
                            id: loadedSlot.id || `default-${index}`, // 确保有ID
                            defaultLabel: defaultLabel,
                            name: loadedSlot.name || '' // 使用保存的名称，如果没有则为空
                        };
                    } else {
                        return {
                            id: `default-${index}`,
                            defaultLabel: defaultLabel,
                            name: ''
                        };
                    }
                });
            } else {
                // 如果没有保存的玩家数据，则初始化为默认的7个玩家槽位
                DEFAULT_PLAYER_PLACEHOLDERS.forEach((label, index) => {
                    playerInputSlots.push({
                        id: `default-${index}`, // 使用固定ID方便识别默认槽位
                        defaultLabel: label,
                        name: '' // 默认为空，等待用户输入
                    });
                });
            }
            renderPlayerInputs();
        }

        function saveData() {
            localStorage.setItem('mahjongSettings', JSON.stringify(settings));
            localStorage.setItem('mahjongPlayerInputSlots', JSON.stringify(playerInputSlots));
        }

        // --- 玩家输入框和标签渲染 ---
        function renderPlayerInputs() {
            playerLabelsContainer.innerHTML = ''; // 清空现有标签
            playerInputsContainer.innerHTML = ''; // 清空现有输入框

            playerInputSlots.forEach((slot) => {
                // 创建标签
                const labelDiv = document.createElement('div');
                labelDiv.className = 'player-label flex-1';
                labelDiv.textContent = slot.defaultLabel;
                playerLabelsContainer.appendChild(labelDiv);

                // 创建输入框
                const inputDiv = document.createElement('div');
                inputDiv.className = 'flex-1'; // Ensure input takes its share of space
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                // MODIFICATION: Set value to empty string to ensure it's blank initially
                nameInput.value = slot.name; // Keep this to load saved names
                nameInput.placeholder = ''; // Set placeholder to empty string
                nameInput.className = 'player-name-input shadow appearance-none border rounded-lg w-full py-1 px-2 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500 transition duration-200';
                nameInput.dataset.slotId = slot.id; // 存储槽位ID，方便事件处理
                
                // 根据玩家数量调整字体大小
                if (playerInputSlots.length > 4) { // 假设超过4个玩家时开始缩小字体
                    nameInput.classList.add('player-name-input-small');
                    labelDiv.classList.add('player-name-input-small'); // Labels also need to shrink
                } else {
                    nameInput.classList.remove('player-name-input-small');
                    labelDiv.classList.remove('player-name-input-small');
                }

                // 添加 focus 事件监听器，清空内容
                nameInput.addEventListener('focus', (event) => {
                    event.target.value = '';
                });

                // 添加 blur 事件监听器，处理保存和恢复默认标签
                nameInput.addEventListener('blur', (event) => {
                    const slotId = event.target.dataset.slotId;
                    const slot = playerInputSlots.find(s => s.id === slotId);
                    if (slot) {
                        const newName = event.target.value.trim();
                        if (newName === '') {
                            // 如果清空，则清空存储的实际名称，输入框值也保持空
                            slot.name = '';
                            event.target.value = ''; // 保持空白
                            showMessage(`玩家 "${slot.defaultLabel}" 已清空`, 'info');
                        } else {
                            // 检查新名称是否与其他已填写的玩家姓名重复
                            const currentFilledNames = new Set(
                                playerInputSlots
                                    .filter(s => s.id !== slot.id && s.name !== '')
                                    .map(s => s.name)
                            );
                            if (currentFilledNames.has(newName)) {
                                showMessage(`玩家姓名 "${newName}" 已存在！请使用其他名称。`, 'error');
                                // 恢复到旧名称
                                event.target.value = slot.name; 
                            } else {
                                // 限制名字长度为最多2个字
                                if (newName.length > 2) {
                                    showMessage('名字最多只能2个字！', 'error');
                                    event.target.value = slot.name; // 恢复旧值
                                    return;
                                }
                                slot.name = newName;
                                showMessage(`玩家姓名已更新为 "${newName}"`, 'success');
                            }
                        }
                        saveData();
                    }
                });

                // 实时更新 slot.name
                nameInput.addEventListener('input', (event) => {
                    const slotId = event.target.dataset.slotId;
                    const slot = playerInputSlots.find(s => s.id === slotId);
                    if (slot) {
                        // 实时更新 name，但不立即保存或处理重复，留给 blur 事件
                        slot.name = event.target.value.trim();
                    }
                });

                // 回车键触发 blur 事件
                nameInput.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // 阻止回车键换行
                        event.target.blur(); // 触发失去焦点事件来保存
                    }
                });

                inputDiv.appendChild(nameInput);
                playerInputsContainer.appendChild(inputDiv);
            });
        }

        // --- 事件监听器 ---

        // 分值设置输入框变化时更新 settings 对象并保存
        baseScoreInput.addEventListener('input', (e) => {
            settings.baseScore = parseFloat(e.target.value) || 0;
            saveData();
        });
        flowerScoreInput.addEventListener('input', (e) => {
            settings.flowerScore = parseFloat(e.target.value) || 0;
            saveData();
        });
        laziScoreInput.addEventListener('input', (e) => {
            settings.laziScore = parseFloat(e.target.value) || 0;
            saveData();
        });

        // 开始记分按钮点击事件
        startGameBtn.addEventListener('click', () => {
            // 收集所有已填写的、非空的、唯一的玩家姓名
            const activePlayersForGame = [];
            const collectedNames = new Set(); // 使用 Set 来确保唯一性

            playerInputSlots.forEach(slot => {
                const name = slot.name.trim();
                // 如果用户输入了名字，则使用用户输入的；否则使用默认标签
                const finalName = name || slot.defaultLabel;

                // 检查最终确定的名字是否重复
                if (finalName && !collectedNames.has(finalName)) {
                    activePlayersForGame.push(finalName);
                    collectedNames.add(finalName);
                } else if (finalName && collectedNames.has(finalName)) {
                    // 如果有重复，提示错误并阻止开始游戏
                    showMessage(`玩家姓名 "${finalName}" 重复！请修改。`, 'error');
                    return; // 阻止继续执行
                }
            });

            if (activePlayersForGame.length < 2) {
                showMessage('请至少添加2位玩家才能开始记分！', 'error');
                return;
            }

            // 将活跃玩家列表和设置保存到 localStorage，供记分页面使用
            localStorage.setItem('activePlayers', JSON.stringify(activePlayersForGame));
            localStorage.setItem('currentGameSettings', JSON.stringify(settings));

            // 跳转到记分页面
            window.location.href = 'scoring.html';
        });

        // 页面加载时执行
        window.onload = () => {
            loadData(); // 加载之前保存的数据或初始化默认槽位
        };

        // --- Service Worker 注册 (PWA 核心) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // 确保 Service Worker 路径的正确性
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker 注册成功:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker 注册失败:', error);
                    });
            });
        }
    </script>
</body>
</html>